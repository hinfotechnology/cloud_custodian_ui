{% extends 'manager/base.html' %}

{% block content %}
<div class="main-header">
    <h1>AWS Resources</h1>
    <p>View and manage your AWS resources across services.</p>
</div>

{% if error %}
<div class="alert alert-danger" role="alert">
    {{ error }}
</div>
{% endif %}

<div class="service-tabs-container">
    <ul class="nav nav-tabs" id="serviceTabs" role="tablist">
        {% for service_name, _ in services.items %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if forloop.first %}active{% endif %}" id="{{ service_name|slugify }}-tab" data-bs-toggle="tab" data-bs-target="#{{ service_name|slugify }}" type="button" role="tab" aria-controls="{{ service_name|slugify }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">{{ service_name }}</button>
        </li>
        {% endfor %}
    </ul>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <input type="text" class="form-control w-50" id="searchInput" placeholder="Search all resources...">
</div>
<div class="card">
    <div class="card-body">
        <div class="tab-content" id="serviceTabsContent">
            {% for service_name, resources in services.items %}
            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ service_name|slugify }}" role="tabpanel" aria-labelledby="{{ service_name|slugify }}-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="mb-0 text-muted">Showing {{ resources|length }} {{ service_name }}</p>
                </div>
                {% if resources %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                {% if service_name == 'EC2 Instances' %}
                                    <th>Instance ID</th>
                                    <th>Type</th>
                                    <th>State</th>
                                    <th>IP Address</th>
                                    <th>Launch Time</th>
                                    <th>Actions</th>
                                {% elif service_name == 'S3 Buckets' %}
                                    <th>Bucket Name</th>
                                    <th>Region</th>
                                    <th>Creation Date</th>
                                    <th>Actions</th>
                                {% elif service_name == 'RDS Instances' %}
                                    <th>DB Identifier</th>
                                    <th>Engine</th>
                                    <th>Status</th>
                                    <th>Endpoint</th>
                                    <th>Creation Date</th>
                                    <th>Actions</th>
                                {% else %}
                                    {% for key in resources.0.keys %}
                                        <th>{{ key|title }}</th>
                                    {% endfor %}
                                    <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for resource in resources %}
                            <tr>
                                {% if service_name == 'EC2 Instances' %}
                                    <td><strong>{{ resource.id }}</strong></td>
                                    <td>{{ resource.instance_type }}</td>
                                    <td><span class="status-badge status-{{ resource.status|lower }}">{{ resource.status }}</span></td>
                                    <td>{{ resource.ip_address }}</td>
                                    <td>{{ resource.creation_date|date:"d/m/Y, H:i:s" }}</td>
                                    <td><a href="{% url 'manager:resource_details' service_name=service_name resource_id=resource.id %}" class="btn btn-sm btn-outline-primary">View</a></td>
                                {% elif service_name == 'S3 Buckets' %}
                                    <td><strong>{{ resource.name }}</strong></td>
                                    <td>{{ resource.region }}</td>
                                    <td>{{ resource.creation_date|date:"d/m/Y, H:i:s" }}</td>
                                    <td><span class="status-badge status-{{ resource.status|lower }}">{{ resource.status }}</span></td>
                                    <td><a href="{% url 'manager:resource_details' service_name=service_name resource_id=resource.name %}" class="btn btn-sm btn-outline-primary">View</a></td>
                                {% elif service_name == 'RDS Instances' %}
                                    <td><strong>{{ resource.id }}</strong></td>
                                    <td>{{ resource.engine }}</td>
                                    <td><span class="status-badge status-{{ resource.status|lower }}">{{ resource.status }}</span></td>
                                    <td>{{ resource.endpoint }}</td>
                                    <td>{{ resource.creation_date|date:"d/m/Y, H:i:s" }}</td>
                                    <td><a href="{% url 'manager:resource_details' service_name=service_name resource_id=resource.id %}" class="btn btn-sm btn-outline-primary">View</a></td>
                                {% else %}
                                    {% for value in resource.values %}
                                        <td>{{ value }}</td>
                                    {% endfor %}
                                    <td><a href="{% url 'manager:resource_details' service_name=service_name resource_id=resource.id %}" class="btn btn-sm btn-outline-primary">View</a></td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>No resources found for {{ service_name }}.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const tables = document.querySelectorAll('.tab-pane table tbody');

    searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        tables.forEach(function(table) {
            const rows = table.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                let cells = rows[i].getElementsByTagName('td');
                let found = false;
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].innerText.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                if (found) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        });
    });
});
</script>
{% endblock %}
